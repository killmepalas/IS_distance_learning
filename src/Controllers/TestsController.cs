using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using IS_distance_learning.Models;
using Microsoft.AspNetCore.Authorization;

namespace IS_distance_learning.Controllers
{
    public class TestsController : Controller
    {
        private readonly AppDbContext _context;

        public TestsController(AppDbContext context)
        {
            _context = context;
        }
        //
        [HttpGet]
        [Authorize]
        public async Task<IActionResult> Details(int id)
        {
            var test = await _context.Tests.Include(t => t.Questions).FirstOrDefaultAsync(x => x.Id == id);
            if (test == null)
            {
                return NotFound();
            } 
            return View(test);
        }

        [HttpGet]
        [Authorize(Roles = "teacher")]
        public IActionResult Create(int CourseId)
        {
            ViewBag.CourseId = CourseId;
            return View();
        }
        
        [HttpPost]
        [Authorize(Roles = "teacher")]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Create([Bind("Name,Description,Date,ExpirationDate,CourseId")] Test test)
        {
            if (ModelState.IsValid)
            {
                var course = await _context.Courses.FindAsync(test.CourseId);
                var teacher = await _context.Teachers.FirstOrDefaultAsync(x =>
                    x.AccountId.ToString() == User.FindFirstValue(ClaimTypes.NameIdentifier));
                if (course == null || course.TeacherId != teacher.Id || test.ExpirationDate.CompareTo(test.Date) <= 0)
                {
                    return BadRequest(new {error = "Data is invalid."});
                }
                await _context.AddAsync(test);
                await _context.SaveChangesAsync();
                return RedirectToAction("Details", "Course", new {id = course.Id});
            }
            return View(test);
        }

        [HttpGet]
        [Authorize(Roles = "teacher")]
        public async Task<IActionResult> Update(int id)
        {
            var test = await _context.Tests.FindAsync(id);
            if (test == null)
            {
                return NotFound();
            }
            return View(test);
        }
        
        [HttpPost]
        [Authorize(Roles = "teacher")]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Update(int id, [Bind("Name,Description,Date,ExpirationDate,CourseId")] Test dto)
        {
            if (ModelState.IsValid)
            {
                var test = await _context.Tests.FindAsync(id);
                if (test == null)
                {
                    return NotFound();
                }
                var course = await _context.Courses.FindAsync(dto.CourseId);
                var teacher = await _context.Teachers.FirstOrDefaultAsync(x =>
                    x.AccountId.ToString() == User.FindFirstValue(ClaimTypes.NameIdentifier));
                if (course == null || course.TeacherId != teacher.Id || dto.ExpirationDate.CompareTo(dto.Date) <= 0)
                {
                    return BadRequest(new {error = "Data is invalid."});
                }

                test.Name = dto.Name;
                test.Description = dto.Description;
                test.Date = dto.Date;
                test.ExpirationDate = dto.ExpirationDate;
                test.CourseId = dto.CourseId;
                return RedirectToAction("Details", "Course", new {id = course.Id});
            }
            return View(dto);
        }

        [HttpPost]
        [Authorize(Roles = "teacher")]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Delete(int id)
        {
            var test = await _context.Tests.FindAsync(id);
            if (test == null)
            {
                return NotFound();
            }
            var course = await _context.Courses.FindAsync(test.CourseId);
            var teacher = await _context.Teachers.FirstOrDefaultAsync(x =>
                x.AccountId.ToString() == User.FindFirstValue(ClaimTypes.NameIdentifier));
            if (course.TeacherId != teacher.Id)
            {
                Forbid();
            }
            _context.Tests.Remove(test);
            await _context.SaveChangesAsync();
            return RedirectToAction("Details", "Course", new {id = course.Id});
        }

        [HttpGet]
        [Authorize(Roles = "student")]
        public async Task<IActionResult> Pass(int testId, int questionId = 0)
        {
            var test = await _context.Tests.Include(x => x.Questions).ThenInclude(x => x.Answers)
                .FirstOrDefaultAsync(x => x.Id == testId);
            if (questionId == 0)
            {
                return View(test.Questions.First());
            }

            var question = test.Questions.FirstOrDefault(x => x.Id == questionId);
            if (question == null)
            {
                return RedirectToAction("Details", "Tests", new {id = test.Id});
            }

            return View(question);
        }

        [HttpPost]
        [Authorize(Roles = "student")]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Pass(int id)
        {
            if (ModelState.IsValid)
            {
                
                var answer = await _context.Answers.FindAsync(id);
                if (answer == null)
                {
                    return NotFound();
                }
                var question = await _context.Questions.FindAsync(answer.QuestionId);
                var test = await _context.Tests.FindAsync(question.TestId);
                var student = await _context.Accounts.FirstOrDefaultAsync(x => x.Login == User.Identity.Name);
                var attempt = await _context.Attempts.FirstOrDefaultAsync(x => x.StudentId == student.Id && x.TestId == test.Id);
                if (attempt == null)
                {
                    attempt = new Attempt
                    {
                        StudentId = student.Id,
                        TestId = test.Id,
                        Mark = (answer.IsRight ? 1 : 0)
                    };
                    
                    await _context.Attempts.AddAsync(attempt);
                }
                else
                {
                    attempt.Mark += (answer.IsRight ? 1 : 0);
                    _context.Attempts.Update(attempt);
                }
                
                await _context.SaveChangesAsync();
                var next = await _context.Questions.FirstOrDefaultAsync(x => x.Id > question.Id && x.TestId == test.Id);
                if (next == null)
                {
                    return RedirectToAction("Details", "Course", new {id = test.CourseId});
                }
                return RedirectToAction("Pass", "Tests", new {testId = test.Id, questionId = next.Id});
            }
            ModelState.AddModelError("", "Ответ на вопрос не выбран!");

            return View();
        }
    }
}



/*
 * ####################################++**;,W#########*:;**++#######################################zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz
####################################++**;,x#########z,;i*+++######################################zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz
####################################+++*;,z#########M,;i*+++######################################zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz
####################################+++*i:*#########@,:i*++++###################################z#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz
####################################+++*i::##########;:;**++++#####################################zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz
####################################+++*i:,@#########*,;i*++++######################################zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz
#####################################++*i;,M#########z,;i*++++#########################################zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz
####################################+++*i;,z#########M.;i*+++++########################################z#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz
####################################+++**;,+#########@,:i**++++##########################################zzz##zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz
####################################+++*ii:;##########::;**+++++##############################################zz###zzzz##zzzzzzzzzzzzzzzzzzzzzzzzzzzzz
####################################+++**i::@#########i:;**++++++##############################################z#zzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzz
####################################+++**i;,M#########*:;**+++++++#######################################################z##zzzzzzzz#zzzzz#zzzzzzzzzzz
####################################+++**i;,z##########,;i**++++++######################################################zzzzz####z##zzzzzz##zzzzzzzzzz
###################################+++++*i;,*#########n,;i***+++++#############################################################################zzzz#z#
###############++#+##+++++++++#++#++++++*i;:i#########M,:ii***+++++++#####+###########################################################################
+#############++++++++++++++++++++++++++*ii::#########@,:ii****++++++++++##++#########################################################################
+++++++####+#++++++++++++++++++++++++++***i:,W#########::;i****+++++++++++++++##+++++##############################################z##################
++++++++++#++++++++++++++++++++++++++++***i;.M#########i,;ii***++++++++++++++++++++++#######++##########################################z#############
++++++++++++++++++++++++++++++++++++++++**i;,z#########+,;ii***++++++++++++++++++++++++++##+++++++++###################################z##############
+++++++++++++++++++++++++++++++++++++++***i;,+#########z,;ii****+++++++++++++++++++++++++++++++++++++##################################z##############
++++++++++++++++++++++++++++++++++++++++**i;:;#########x,:;iii***++++++++++++++++++++++++++++++++++++##################################zzz############
++++++++++++++++++++++++++++++++++++++++**i;:,@########W,:;iiii**++++++++++++++++++++++++++++++++++++#################################################
++++++++++++++++++++++++++++++++++++++++**ii:,W########@,:;;iii***++++++++++++++++++++++++++++++++++++################################################
*++++++++++++++++++++++++++++++++++++++***ii;,n#########;,:;iiiii**++++++++++++++++++++++++++++++++++++####################################z##########
*++++++++++++++++++++++++++++++++++++++***ii;,+#########*,:;;;;iii***++++++++++++++++++++++++**++++++++++#+###########################################
**+++++***+++++++++*******++++++++++++****ii;,;##########.::::;;;ii****++++++++++++++++++++****+++++++++++++##########################################
***************++*************+++++++*****ii;::@########n.,,:,,,::;i****+++++++++++++++++*********+++++++++++++######################################+
*****************************************ii;;:.W########M.....,in+:ii******+++++++++**************++++++++++++++++##################################++
i***************************************ii;;::.n########@**#nW@##M,;i********+++++++*******i*******+++++++++++++++++##############################++++
ii*************************************iii;::,.##################W,;iii*******************iiiii****+++++++++++++++++++++#########################+++++
iiiiiiiii*iii*****iiiiiiii************ii;:,,,,;n#################M,;;iii*****************iiiiiii****+++++++++++++++++++++++#####################++++++
iiiiiiiiiiiiiiiiiiiiiiiiii***********ii;:+zxW@###############@Mn+:,:;iiii*************iiiiiiiiiii*****++++++++++++++++++++++++++###############+++++++
;;;iiiiiiiiiiiiiiiiiiiiiiii*********ii;:n###############@Mz*;,...,::;;iiiii**********iiiii;;;;iiii****+*******++++++++++++++++++++++###########++++++*
;;;;;;iii;iiiiiiiiiiiiiiiiiiiiiiiiiiii;:x########@Wxz*i:,.....,,,,::;;;iiiiiiiiii**iiiiii;;;;;;iii*************++++++++++++++++++++++++++#++++++++****
;;;;;;;;;;;;;;;;;;;;i;;iiiiiiiiiiiiiii;:z#@Wxz+*;,.`````...,,,,,,,,:::;;iiiiiiiiiiiii;;;;;;::;;;iii**************+++++++++++++++++++++++++++++++++****
;;:;;;;;;;;:;;;;;;;;;;;;;iiiiiiiiiiiii;;:i:,,..,,,..`````..,,,,,,,,,:::;;;;;ii;;;;ii;;;:::::::;;;iii*****i***i*****++++++++++++++++++++++++++++++*****
::::::::::::::::;;;;;;;;;;iiiiiii;;i;;;;:::::,,,,,.```..``..,,,,,,,,,,::;::;;;;;;;;;;::::::::::;;iiii*iiiiiiiii*********+++++++++++++++++++++++*******
:::::::::::::::::::::;;;;;;;;;;;;;;;;;;;;:::::,,,,.`.,,,.``..,,,,,,,,,,::::::::::::;::::::::::::;;iiiiiiiiiiiii***********+++++++++++++++++++++***iiii
::::::::,,,,,,,,:::::::;;;;;;;;;;;;;:;;;;:::::,,,,``.,,,,.``..,,,,,,,,,,:,,,,,::::::::,,:,,:::::;;;iiiii;;;;iiiiii*************+++++++++++++*****iiiii
,,,,,,,,,,,,,,,,,,,:::::::::;;;;;;;:::;;:::::,,,,.`.,,,,,,.``.....,,,,.,,,,,,,,,,,,,,,,,,,,,::::;;;;;;;;;;;;;iiiiiii**************++************iiiiii
,,,,,,,,,,,,,,,,,,,,,::::::::::::::::::::::::,,,..`.,,,,,,,.``..,.,,,,...,,,,,,,,,,,,,,,,,,,,:::;;;;;;;;;:::;;;iiiiiiiii***********************iiiiiii
.........,,,,,,,,,,,,,::::::::::::::::::::::,,,,..`.,,,,,,,,.``..,,,,......,....,,,,,,,,,,,,,,,:::::;::::::::;;;;;;iiiiiiii******************iiiiii;;;
..............,,,,,,,:::::::::::::::::::::::::,,.``,,,,,,,,,,.``..,,,,...............,,.,,,,,,,,:::::::::::::;;;;;;;;;;iiiiii*************iiiiiii;;;;;
..............,,,,,,,,:::::::::::;;;:::,::::::,,.`.,,,,,,,,,,,``...,,,.................,.,,,,,,,,::::::::::::;;;;;;;;;;;;iiiiiii**ii**iiiiiiii;;;;;;;;
............,,,,,::::::::;;::::;;;;;;:::::::::,,.`.,,,,,,,,,,,,``..,,,,....................,,,,,,,::::::::::::;;;;;:::;;;;;iiiiiiiiiiiiiiii;;;;;;;;;;;
...........,,,,,:::::::::::::::;;;;;;:::::::::,,``.,,,,,,,,,,,,,``..,,,.....................,,,,,,:::::::;:::::;::;::::::;;;iiiiiiiiiiiii;;;;;;;;;;;;;
.........,,,,,,::::::::::::::::;;;;;;:::::::::,,``,,,,,,,,,,,,,,.``.,,,,....................,,,,,,::::::::::::;;;::::::::::;;;;;;;;;;;;;;;;;;;;;;;;;;;
........,,,,,,,:::::::::::::::::::;;;;::::::::,.`.,,,,,,::,,,,:,,.``..,,,...................,,,,,,:::::::;::::;;:::::::::::::;;;;;;;;;;;;:::::::::::::
.......,,,::::::::::::::::::::::::::::::::::::,.`.,,,,,,,,,,,,,,,,.``.,,,,..................,,,,:::::::;;;;::;;;::::::::::::::;;;;;;;;;;::::::::::::::
......,,,,::::::::::::::::::::::::::::::::::::,``,,,,,,,,,,,,,,,,,,.``.,,..................,,,,,::::::::::::;;;;::::::::::::::::::;;::::::::::::::::::
.....,,,,,,,:::::::::::::::::::::::::::::::::,.`.,,:,,,,,,,,,,,,,,,,.`...,.................,,,,,:::::::::::::;::::::::::::::::::::::::::::::::::::::::
.,,,,,,,,,,,,,::::::::,::::,,,,,,,,,,,::::::,,.`.,,,,,,,,,,,,,,,,,,,,```.,..................,,,,,:::::::::::::::::::::::::::::::::::::::::::::::::::::
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,``,,,:,,,:,,,,,,,,,,,,,,```...................,,,,,,::::::::::::::::::::::::::::::::::::::::::::::::::;;
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.``,,,,,,,,,,,,,,,,,,,,,,,```..................,,,,,,,,,,:::,:::::::::::::::::::::::::::::::::::::::::::;
.......,.,,,.,,,,,,,,,,,,,,,,,,.....,,,,,,,,,.`.,,,,::,,,,,,,,,,,,,,,,,.``....................,,,,,,,,,,,,,,:::::::::::::::::::::::::::::::::::::::;;;
.............,,,,,.....................,,,,,,.`.,,,,::,,,,,,,,,:,,,,,,,,.``...................,,,,,,,,,,,,,,,,:::::::::::::::::::::::::::::::::::::;;;
.........................................,,,.``,,,,,,,,,,,,,,,:n,,,,,,,,,.``....................,,,,,,,,,,,,,,,:,:::::::::::::::::::::::::::::::::;;;;
.........................................,,..`.,:,,,,,,i*,,,,,i#,,,,,#:,,,.``....................,,,,,,,,,,,,,,,,,:::::,::::::::::::::::::::::::::;;;;
.........................................,...`.,,,,,,,,**,,,,,#i,,,,+#,,,,,.``.....................,,,,,,,,,,,,,,,,,:,,,:::::::::::::::::::::::::::;;;
.............................................`.,,,,,,,,*+,,,,,z;,,,,x:,,,,,,.`......................,,,,,,,,,,,,,,,,,,,,::::::::::::::::::::::::::::;;
............................................``,,,**,,,,:n.,;*+M#i;,;n,,,,,:,,```.......................,,,,,,,,,,,,,,,,,,,:::::::::::::::::::::::::;;;
............................................``,,,;x,,,,.nnxz+**+zxMWx,,,,,,,,,```......................,.,,,,,,,,,,,,,,,,,,,,:::::::::::::::::::::::::
............................................`.,,,,#+,,,#x;``     ``:+x*,,:,,,,.```.......................,,,,,,,,,,,,,,,,,,,,,,:::::::::::::::::::::;:
...........................................``.,,,,,n**Mi`            .+xi,,:,,,.```.......`................,,,,,,,,,,,,,,,,,,,,,,:::::::::::::::::::::
...........................................``,,,,,,,Wn.                ,x#,,,,,,.```......``..``...........,,,,,,,,,,,,,,,,,,,,,,,,:::::::::::::::::::
...........................................`.,,,,,,z#`                  `#x:,,,,,.```......`````.```........,,,,,,,,,,,,,,,,,,,,,,,:::::::::::::::::::
..........................................``.,,,,,+#`                   ``;x:,,,,,.``.......````````............,,,,,,,,,,,,,,,,,,,,,:::::::::::::::::
..........................................``,,,,,;n`                     ` ,x;,,,,,.```......````````...................,,,,,,,,,,,,,,::::::::::::::::
..........................................``,,,,,x,  :n:                    ,xi,,,,,.```....````````````..............,..,,,,,,,,,,,,,::::::::::::::::
..........................................`.,,,,z*  `M#@,                    ,x;,,,,,.```....````````````................,,,,,,,,,,,,,,:::::::::::::::
.......``...````.........................``.,,,;x`  .@##z                     :x,,,:,.```....`````````````................,.,,,,,,,,,,,,,,,::,,:::::::
..```.`````````````..```.``..............``.,,,z;   .@##@.                     in,,,,,,```.....```````````...................,...,,,,,,,,,,,,,,,::::::
`.`````````````````.`````...``...........``,,,;n`   `W###+                      #+,,,,,.```....`````````````.....................,,,,,,,,,,,,,,,,,::,:
````````````````````````````..``.........`.,,,z;     x###W`                   ` `n;,,,,,.```....`````````````.......................,,,,,,,,,,,,,,,,,,
````````````````````````````............``.,:,x`     #####i      ``.,::::,..`    #*,,:,,,.```....``````````````.........................,,,,,,,,,,,,,,
````````````````````````````............``,,,i#     `,@###M:i#znxxxnnnnzznnxxn#;.x,,,:,,,,.```....````````````````...........................,,,,,,,,,
``````````````````````````````..........``,,,#;      `M##@Wn#*;::::::::::::::;i#M#,,,,,,,,,.```.....`````````````````.............................,,,,
```````````````````````````````........``.,,,n.    `:#Wn+;::::::::::::::::::::::x;,,,,,,,,:,.```.....```````````````````............................,,
`````````````````````````````````......``.,,,x`  `*xn*;::::::i*#nxMMMx+:::;::::##,,,,,,,,,:,,.````...```````````````````..............................
```````````````````````````````````....``,,,:x `+x+;:::::;+nxn#*i;::;;i:::::::;x:,,,,::,,,:,,,.```....`````````````.`.................................
``````````````````````````````````.....``,,,,n;n+::::::*nx+;::::::::;::::::::;x;,,,,,,,,,,,,,,,.```.........`````.....................................
``````````````````````````````````....``.,,,,;Wi::::::*ni::::::::::::::::::::x*,,,,,:,,,,,,,:,,,.``..........`..............................`.........
```````````````````````````````````...``.,,,,:in:::::::::::::::::::::::;::::x*,,,,,,,,,,,,,,,,,,,.```......................`````....`.................
```````````````````````````````````...``,,,,:,,ixi::::::::::::::::::::::::;x*,,,:,,,,,,,,,,,:,,,,,.```.............`````.,:i+zxMWWWMi`................
  ````````````````````````````````...``.,,,,:,,,;n#::::::::::::::::::::::iM*,,,,,,,,,,,,,,,,,,:,,,,```.......```..:;i+zMW@##@@@@@@@@@;.......``.......
  `````````````````````````````````..``.,,,,,,,,,,+x+::::;::::::::::::::#W;,,,,,,,,,,,,,,,,,,,,,,,,.```..`.,;*zxW@##@@@@@@@@@@@@@@@@@M.......``.`````.
 ``````````````````````````````````.```.,,,,,,,,,,,:zx*:::::::;:::::::*xzx:,,,,,,,,,,,,,,,,,,,,,,,,,.``.inW@@@@@@@@@@@@@@@@@@@@@@@@@@@;.......````````
        ``  ``    ````````````````..```,,,,,,,,,,,,,,:#xz*;::::::::izxz;,*z,,,,,,,,,,,,,,,,,:,,::,,,,,#W#@@@@@@@@@@@@@@@@@@@@@@##@@@@@z`......````````
            ``````````````````````...`.,,,:,,,,,,,,,,,,#xzMxn##zzxxMx:,,,,xi,,,:,,,,,,,,,,,,,,,,,,,,,#@@@@@@@@@@@@@@@@@@@WMxz#*i+@@@@@W......````````.
``          `````````````````````...``.,,,:,,,,,,,,,,,;x,,,,:znii;,;z,,,,,iM:,,,,,,,,,,,,,,,,,,,,,,,,W@@@@@@@@@@@@Wxn+*;,.```...`n@@@@@:......```````.
                `````````````````...``.,,,,,,,,,,,,,,,n;,,,,,#+,,,,:M,:,:,,*;,,,,,,,,,,,,,,,,,,,,,,,,z@@@@@Mnz+i;,.```.`.........:@@@@@*......`.``````
            ``    `````````````.....``,,,:,,,,,,,,,,,:x,,,,,,z*,,,,,x;,,,,,:,,,:,,,,,,,,,,,,,,,,,,,,,,;;;:.```....................M@@@@z`.....`.``````
         `````````````````````......``,,,,,,,,,,,,,,,*#,,,,,,z*,,,,,*i,,,,,,,,,,,,::,,::,::,,,:::::,:::::,.``.....................#@@@@W.......```````
        ````````````````````.......``.,,,,,,,,,,,,,,,#i,,:,,,*;,,,,,,,,::,,,,,,,,,,,,,,,,:::::::;;;;;;;::,,.``........``..``......;@@@@@,.....````````
        ```````````````.````......```.,,,,,,,,,,,,,,,,,,,:,,,,,,,,,,,,,,,::,:::,:::::::::;;;;;;;:::::,,,,,,,```.......````````.....W@@@@i.......``````
        ```````````````...`````.:i+,`,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,::::::::;;;;;::::::;:,,,,,,,,,::,,,.```.....``````````...`n@@@@z`......``````
    ``  ```````````.``````.:+zM@@@@:`,,,,,,,,,,,,,,,,,,,,,,,,,,,::::::::::;:;;;:::::,,,,,,,:::,,,,,,,,,,,,,,,,``......`````````....*@@@@M......```````
    ````````````.`````,i#M@#@@@@@@@:.,,,,,,,,,,,,,::,,,,,,::::::;;;;;;::::,,::,:,,,,,,,,,,,:;,,,,,,,,,,,,,,,,,.```.....````````....,@@@@@,......``````
     ````````````.:*nM@@@@@@@@@@@@M..,,,,,,,,,,,::::::::;;;;;;;;;:::::,,,,i#,,,,,:,,,,,,,,,,::,,,,,,,,,,,,,,,,,.```....````````.....M@@@#*.......`````
    ` ````````.inW@@@@@@@@@@@@@@@@*`,:::::::::::;;;;;:::::::,,,:::,,,,,,,#@W:,:,,,,,,,,,,,,,::,,,,,,,,,,:::::::,.``.....````````...`#@@@@n`......`````
    ````````.#W@@@@@@@@@@@@@@@Mzi:`.::;;;;;;;:::::,,::,,,,,,,,,::::,,,,;x##@::,:,,,,,,,,,,,,;::,:::::::;;;;;:::,,.``.....````````..`;@@@@W......``````
    ````````z@@@@@@@@@@@@@x#i,..```.::::::;:,,,,,,,,,,,#zi,,,,:,::,,,,+@###@;:::,,,,,,,:::::;;:;;;;;:::::,,,,,,,,,.``....````````..`.W@@@@:......`````
``` ```````,@@@@@@@@@@x+;.``.....``.:,,,,,::,,,,,,,,,,,###Wzi:,,:;:,:n######*:::::::::;;;;;;:::::,,,,,,,,,,,,,,,,,,.```...```````...`n@@@@#`.....`````
```````````i@@@@@@Wzi.```........``,,,,,,,:::,,,,,,,,,,+#####Wn*::,iW#######z:;;;;;;::::::,,,,,,,,::,::,,,,,,::,,,,,.``......````...`i#@@@W.......````
 ``````````+@@@@@x.`.............`.,,,,,,,:::,,,,,,,,,:*########@Mx@########x::::::;:,,,,,,,,,,,,,,,,,,:,,,,,,,,,,,,,`````...`````...,@@@@@;.....`````
 ``````````+@@@@@:.......`......``.,,,,,,::;::,,,,,,,,:i########@MzM########M,:,,,:;:,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:,,.```...`````...`x@@@@n`....`````
 ``````````+@@@@W......`.``.....``,,,,,,,::;:::::::::::*#######@#,,,;#M@####W::,,,:;:,,:,,,,,,::::,,,,,,,,,,,,,,::::,,,```......```..`*@@@@@i`...`````
 ``````````#@@@@W.....``````....``,,,,:::::;:::;;;;;;::;@#####Mi,,:,,,,;#M@#W:,,,,,;:,,,,,,,,,,,,,,,,,,,:::::::;;;;::,,.````.....``...,@@@@@W,`.``````
` `````````+@@@@W....```````...``.,:::;;;;;;::::::;::,,,@###@#:,,,,:,,,,,,;+z:,,,,,::,,,,:,,,,,,,:::::::;;;;:::::::,,,,,.````....```..`n@@@#@z`..`````
` ```````.`#@@@@W....```````...``,:::::::,,,,,,,,,;:,,,,W##x;,,,,,,,,,,,,,::::,,,,,:::,,,,::::::;;;;;;;;:::,,,:,,,,,,,,,,.``````.```..`:@@@@#W.`.`````
` `````````#@@@@W...````````...``,,,,,,,,,,,,,,,,,;:,,,,x@#,,,,,,,,,,,,,,,,,,,,:,,::;::::;;;;;;::::,,,:;:,,,,,,,,,,,,,,,,,.`````.````...+@#@@M``.`````
` `````````+@@@@M`..````````...``,,,,,,,,,,,,,,,,,;:,,,,*i,,,,,,,,,,,,,:,,,,::::;;;;;;;::::,,,,,,,,,,,:;:,,,:::::,,,,,,,:,,.`````````...`iW@M;````````
   ``````.`*@@@@M`..````````..```,,,,,,,,,,,,:,,,,::,,,,,,,,,,,:,,::::::::;;;;::::::,,,,,,,,,,,,,,,,,,:;:,:,,,,,,,::,,:::,,.```.```````..``.``````````
 ````````.`*@@@@M...````````..``.,,,,,,,,,,,,,,,,,::,,,,:,,:::::::;;;;;;::::::,,,,,,,,,,,,,,,,,,,,,,,,:::::,,,,,:,,:,,,,,,,.```````````..`````````````
 ````````.`i@@@@W...````````..``.,,,,,,,,,,,,,,,,,:;:::::::;;;;;::::::,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:::::,:::::::,::,,,,.```````````````.```````````
 ````````.`i@@@@W...```````...``,,,,:,,,,,,,::::::;;;;;;::::::::,,,,:,,,,,,,,,,,,,,,,,,,,,,,:,,,,,,,::::;,:,,,,,,,,:,,,,..````````````````````````````
 `````````.;@@@@W...```````..``.,,,:::::::::;;;;::::::::,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:,,,,,,,:,,:;:,,,,,,,,,,...```````````````````````````````
`````````.`:@@@@@....`````...``.::::;;;;;:::::,,,,,,,,::,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,::,,,,,,:,,....````````````.``````````````````````````
` ```````..:@@@@@,..``````...``,;;:::::,,,,,,,,,,,,,,,::,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:,,,:,,,,,,,,,,....```````````````.....``````````````````````````
` ```````..:@@@@@,..``````...``,:::,,,,,,,,,,,,,,,,,,,:;,,,,,,:::,,,,,,,,,,,,,,,,,:,,,,,,,,....````````````````..``........```````````````````````````
  ````````.;@@@@#:...`````..```,,,,,,,,:,,,,,,,,,,,,,,:;:,,,:::,,,,,::,,,,,,,,,,,,,,...`````````````.....................`````````````````````````````
  ````````.;#@@@#;...`````..``.,,,,,,,,:,,,,,,,,,,,,,,:;:,,:::,,,,,,,,,,,,,,....````````````.....,,,,,,,:,,,,,,,........``````````````````````````````
  ```````..;@@@@#i,...````.```,,,,,,,,,:,,,,,,,,,,,,,,:;:::::,,,,,....`````````.i+;``...,,,,,,:::::::::::::::::::::,,...``````````````````````````````
  ``````.,.;@@@@#i,,..```...``,,,,,,,,,:,,,,,,,,,,,,,,,:,,,,...````````````..`:@@@W..,,::::::::::::::;;;;;;;;;;;;;;;;::,...```````````````````````````
 ```````.:,;@@@@#i,:,.```...``,,,:,,,,,,,:,,,,,,,,...``.`````````.......,,,,,.:@@@@,,:::;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;::,,.````````````````````````
 ``````.:;,:@@@@@i,::,....,,.`,:::,,,,,,,,,...`````````.inzi`...,,,,,::::::::,,@@@@;,::;;;;;;;;;;;;;;;;;;;;;iiii;;;;;;;;;;;;;;:,,..```````````````````
``````,:;i::@@@@#i,:::..,::::``.,......``````````......*@@@#.,,,::::;;;;;;:::,.W@@@*,:;;;;;;;;;;;;;;;iii;ii;iiiiiii;;;;;;;;;;;;;;;::,...``````````````
````.:;;ii:;@#@##;,::;:::;;:;:````` ``````.....,,,,,:,.i@@@z.,:::;;;;;;;;;;:::.x@@@z.:;;;;;;;;;;:::;;iiiiiiiiiiiiiiiiiiiiiiiiiii;;;;;;::,...``````````
```.:;;iii:i##@#@,::;;;;;;;;*i,........,,,,,,:::::::::,:@@@n.:::;;;;iiiii;;;::.z@@@M.:;;;;;;;;;::#i:;iiiiiiiiiiiiiiiiiiiiiiiiiiiiii;;;;;;;;:,,..`.````
``,;;iii**::@#@#z,:;;;;;;;;i#+;::,,,,,:::::::::;;;;;;:,,@@@M.:::;;;iiiiii;;;;:,+@@@@,::;;;;;;::,M#W::;iiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiii;;;;;;:,,...`
::;;iiii**;,z##M,:;;;;;;;;;*##i;:::::::;;:;;;;;;;;;;;;:.M@@W.:::;;;iiiiiii;;;:,;#@@@;,:;;;;;:,,n#@#*:;iiiiiii*iiii*iiiiiiiiiiiiiiiiiiiiiiiiiii;;;;;::,
#;;iiiii+*i::ii,:;;;;;;;;;;+zz*;;;;;;;;;;;;;;;;;;iii;;:,n@@@,:::;;;iiii;i;;;;;:,W@@@#,::;;:::.##@@@n,:;iiiiii*ii***iiiiiiii*i*iii*iiiiiiiiiiiiiiii;;;;
ziiiiii*++*;;:::;;;;;;;;;;i#zz#;;;;;;;;;;;;;;;;iiiiii;:,+@@#;,::;;;;ii;;;;;;;::.x@@@M.,::::,.#@@@@@W,:;iiiiii*******iiii******************iiiiiiiiiiii
##iiiii*+++ii;;;;;;;;;;;;iinnnziiiiii;;;;;;;;;;iiiiii;;:;@@#*,::;;;;;;;;::,,:::,*@@@@i,,,,,.+@@@@@@@::;;iiiii*******iiii*******************iiiiiiiiiii
z#*i***++++iii;;;;;;;;;iii*nnnn*iiiiii;;;;;;;;;iiiiii;;:,@@@z,:::;;;;;::,*Mn,::,:@@@@M....:n@@@@@@@@*,;iiiiii*********************************iiiiiiii
##+****++++ii;;;;;;;;;iiii#nxxn+*iiiii;;;;;;;;iiiiiiii;:,M@@M,,:::;;;:,.+@@@i,:,.n@@@#ni#M@@@@W;@@@@#,:;iiiii*********************************ii*iiiii
+++****++++*ii;;;;;i;;iiiizxxxnzi*iiii;;;;;;;iiiiiiiii;:,#@@@:,:::::::.+@@W@z,::,:@@@@@#@@@@@W:.W@@@x,:;iiiii**i**i******************************iiiii
z*****+++++*i;;;;;;;;;iii*nxxxnn***iii;;;;;;iiiiiiiiiii;,;@@@#.:::::,.+@@@@@M,:::,+@@@@@@@@@W:..M@@@W,:;iiiiiii***********************************iiii
n*****#+++++;;;;;iiiiiiii+nxxxxn+**iii;;;;;;iiiiiiiiiii;:,W@@M.,,,,,.z@@@@@@@:,:::,n@@@@@@@M:,,.x@@@@,:;iiiiii*************************************iii
x+***+#+++++ii;iiiiiiiiii#xxxxxz#iiiii;;;;;iiiiiiiiiiii;;,z@@#*.,..:x@@@#@@@#;,::::,z@#@@@z,,,,.n@@@@::;iiiiii**************************************ii
xz***##+++++iiiiiiiiiii**nxxxxxnz*iiii;;;;iiiiiiiiiiiii;;:i@@@W,`,+W@@@@x@@@@i,:;;;:,:+#*,,::::.n@@@@::;iiiiii**************************************ii
xxz*zz##++++iiiiii*iiii*+nxxxxnnz*iiiii;;iiiiii*iiiiiii;;:,M@@@WM@@@@@@#:@@@@+,:;;;;;:,::::;;;:,z@@@@::;iiiiii***************************************i
xnxz#x++++++*iiiii*iiii*#xxxxxnzz+iiiiiiiiiiiiiiiiiiiiiii;,+@@@@@@@@@@z.,@@@@+,:;iiii;;ii;;i;;;,#@@@@::;iiiiii*****************i*********************i
x*Mzin+++++**iiii*+iiii*nxxxxxx*z#i;iiiiiiiiiiiiiiiiiiii*i:,W@@@@@@@@z..:@@@@z,:;iiiiiiiiii+i;;,#@@@@::iiiiii*********+*******************************
i+Mix#+++++*****i*+***i+nxxxxxx*+zi;iiiiii**iiiiiiiiiiii**;,i@@@@@@@+.,,:@@@@n,;;ii**i*****+ii;,+@@@W,;iiii*i********+#**************i****************
.*i#nnxx#++******++****##xxxxxx+i#i;iiiiii**iii*iiiiiiii**i;,i@@@@M;.::,:@@@@n,;;ii********#*ii:i@@@n,;i*i******+****##*******************************
..:MMn:ix+++i***i++***i+*xxxxxn#;ii;iiiiii***iiiiiiiiii****;:,:##i,,:::,:@@@@n,;ii********+z**i;:W@@i:ii********+**+*#z******************ii***********
+.z+xM;,zn++*****#+**iii+xxxxxxz;;;;iiiiii+*iiiiiiiiiii*+**i;;:::::;;;;,;@@@@n,;ii********+z+**i;;+*:;i*******+++**+*#z+***++***ii***i****************
M*M+#nz,:#x#****+##+*iii#xxxxxxzi;;;iiiiii+*iiiiiiiiii*++++*iii;;;;ii;;:i@@@@z,;i******+**#n+**ii;;;ii*******++++**++#n****+****ii***iii***iii***i****
nxMz;nzz;,#x+*#+###+*ii;zxxxxxxn*;;;iiiii*#*iii*iiiiii*++++*iiiiiiiiii;:i@@@@+:;i******+++zn#****iiii*******++++++++*zn+**++****ii***iii***iii********
 */
